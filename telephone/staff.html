<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff KB Tech - T·ªïng ƒë√†i vi√™n</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #111; color: #fff; display: flex; height: 100vh; overflow: hidden; }
        
        /* C·∫£nh b√°o Mobile */
        #mobileBlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #mobileBlock i { font-size: 50px; color: #cc0000; margin-bottom: 20px; }
        
        /* Layout ch√≠nh */
        .sidebar { width: 350px; background: #1e1e1e; display: flex; flex-direction: column; border-right: 1px solid #333; }
        .main-stage { flex: 1; position: relative; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Header Sidebar */
        .staff-info { padding: 20px; border-bottom: 1px solid #333; background: #252525; }
        .staff-info h2 { margin: 0; font-size: 18px; color: #cc0000; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-top: 5px; font-weight: bold; }
        .st-online { background: #28a745; color: #fff; }
        .st-busy { background: #ffc107; color: #000; }
        .st-offline { background: #6c757d; color: #fff; }

        /* Chat Area */
        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .messages-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 10px; max-width: 90%; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg.client { background: #333; align-self: flex-start; border-bottom-left-radius: 0; }
        .msg.me { background: #cc0000; align-self: flex-end; border-bottom-right-radius: 0; }
        .msg.system { background: transparent; color: #888; font-size: 12px; text-align: center; align-self: center; width: 100%; }
        
        .chat-input { padding: 15px; background: #252525; display: flex; gap: 10px; border-top: 1px solid #333; }
        .chat-input input { flex: 1; padding: 10px; border-radius: 20px; border: none; background: #333; color: #fff; outline: none; }
        .chat-input button { background: #cc0000; color: #fff; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

        /* Video Area */
        .video-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; }
        video#localVideo { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .overlay-wait { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #777; font-size: 20px; text-align: center; pointer-events: none;
        }
        
        /* THANH ƒêI·ªÄU KHI·ªÇN */
        .control-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; z-index: 100;
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 50px;
            backdrop-filter: blur(5px);
        }
        .ctrl-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; color: #fff;
        }
        .ctrl-btn.on { background: #444; }
        .ctrl-btn.on:hover { background: #666; }
        .ctrl-btn.off { background: #cc0000; position: relative; }
        .btn-end { background: #cc0000; padding: 0 30px; border-radius: 30px; width: auto; font-weight: bold; display: none; }
        .btn-end:hover { background: #ff0000; }

        /* M√ÄN H√åNH CU·ªòC G·ªåI ƒê·∫æN (INCOMING CALL) */
        .incoming-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 999;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.3s;
        }
        .incoming-box {
            background: #222; padding: 40px; border-radius: 20px; text-align: center;
            border: 2px solid #cc0000; box-shadow: 0 0 50px rgba(204, 0, 0, 0.5);
        }
        .avatar-call {
            width: 100px; height: 100px; background: #444; border-radius: 50%;
            margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;
            animation: pulse 1.5s infinite;
        }
        .action-buttons { margin-top: 30px; display: flex; gap: 20px; justify-content: center; }
        .btn-accept { background: #28a745; color: white; padding: 15px 40px; border: none; border-radius: 50px; font-size: 18px; cursor: pointer; font-weight: bold; }
        .btn-reject { background: #dc3545; color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 18px; cursor: pointer; font-weight: bold; }
        .btn-accept:hover { background: #218838; }
        .btn-reject:hover { background: #c82333; }

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(204, 0, 0, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(204, 0, 0, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(204, 0, 0, 0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <audio id="ringtone" loop>
        <source src="https://cdn.pixabay.com/download/audio/2021/08/09/audio_88447e769f.mp3?filename=phone-calling-1-14311.mp3" type="audio/mpeg">
    </audio>

    <div id="mobileBlock">
        <i class="fas fa-desktop"></i>
        <h2>CH·ªà D√ÄNH CHO PC</h2>
        <p>H·ªá th·ªëng Staff ch·ªâ ho·∫°t ƒë·ªông tr√™n m√°y t√≠nh ƒë·ªÉ b√†n ho·∫∑c laptop.</p>
    </div>

    <div class="incoming-modal" id="incomingModal">
        <div class="incoming-box">
            <div class="avatar-call"><i class="fas fa-user" style="font-size: 40px;"></i></div>
            <h2>KH√ÅCH H√ÄNG ƒêANG G·ªåI...</h2>
            <p>Y√™u c·∫ßu h·ªó tr·ª£ tr·ª±c tuy·∫øn</p>
            <div class="action-buttons">
                <button class="btn-reject" id="btnReject"><i class="fas fa-times"></i> T·ª´ ch·ªëi</button>
                <button class="btn-accept" id="btnAnswer"><i class="fas fa-phone"></i> NGHE M√ÅY</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="staff-info">
            <h2><i class="fas fa-headset"></i> STAFF CONSOLE</h2>
            <div id="connectionStatus"><span class="status-badge st-offline">ƒêang kh·ªüi t·∫°o...</span></div>
            <div style="font-size: 12px; color: #aaa; margin-top: 5px;">ID: <span id="myIdDisplay">...</span></div>
        </div>

        <div class="chat-container">
            <div class="messages-list" id="msgList">
                <div class="msg system">Ch√†o Staff! ƒêang ki·ªÉm tra thi·∫øt b·ªã...</div>
            </div>
            <div class="chat-input">
                <input type="text" id="msgInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
                <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="main-stage">
        <div class="no-cam-alert" id="noCamAlert" style="display:none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: orange; padding: 5px 15px; border-radius: 20px; font-size: 13px;">‚ö†Ô∏è Ch·ªâ d√πng Mic</div>
        
        <div class="video-wrapper">
            <div class="overlay-wait" id="videoPlaceholder">
                <i class="fas fa-camera-slash" style="font-size: 40px; margin-bottom: 10px;"></i><br>
                Camera ƒëang t·∫Øt
            </div>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>

        <div class="control-bar">
            <button class="ctrl-btn on" id="btnToggleMic" title="B·∫≠t/T·∫Øt Mic"><i class="fas fa-microphone"></i></button>
            <button class="ctrl-btn on" id="btnToggleCam" title="B·∫≠t/T·∫Øt Camera"><i class="fas fa-video"></i></button>
            <button class="ctrl-btn btn-end" id="endCallBtn"><i class="fas fa-phone-slash"></i> &nbsp;K·∫æT TH√öC</button>
        </div>
    </div>

    <script>
        const STAFF_PEER_ID = "kbtech-hotline-vip-1";
        
        let peer = null;
        let pendingConn = null; // K·∫øt n·ªëi ƒëang ch·ªù nghe m√°y
        let activeConn = null;  // K·∫øt n·ªëi ƒëang ho·∫°t ƒë·ªông
        let activeCall = null;
        let localStream = null;
        let isVideoAvailable = false;

        const ringtone = document.getElementById('ringtone');
        const incomingModal = document.getElementById('incomingModal');

        // 1. KI·ªÇM TRA H·ªÜ TH·ªêNG
        function checkSystem() {
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                document.getElementById('mobileBlock').style.display = 'flex';
                return false;
            }
            return true;
        }

        async function initStaff() {
            if (!checkSystem()) return;

            logSystem("... ƒêang qu√©t thi·∫øt b·ªã ...");

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                isVideoAvailable = true;
                document.getElementById('videoPlaceholder').style.display = 'none';
                logSystem("‚úÖ ƒê√£ t√¨m th·∫•y Camera & Mic.");
            } catch (err) {
                console.warn("L·ªói Camera:", err);
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                    isVideoAvailable = false;
                    document.getElementById('noCamAlert').style.display = 'block';
                    document.getElementById('btnToggleCam').classList.add('off'); 
                    document.getElementById('btnToggleCam').disabled = true;
                    document.getElementById('videoPlaceholder').innerHTML = '<i class="fas fa-microphone"></i><br>Ch·∫ø ƒë·ªô ch·ªâ √Çm thanh';
                    logSystem("‚úÖ ƒê√£ k·∫øt n·ªëi Mic (Audio Only).");
                } catch (err2) {
                    alert("L·ªñI: Kh√¥ng t√¨m th·∫•y Mic! Vui l√≤ng ki·ªÉm tra l·∫°i.");
                    return;
                }
            }

            if (isVideoAvailable) {
                document.getElementById('localVideo').srcObject = localStream;
            }

            // K·∫æT N·ªêI PEERJS
            peer = new Peer(STAFF_PEER_ID);

            peer.on('open', (id) => {
                document.getElementById('myIdDisplay').innerText = id;
                setStatus('online');
                logSystem("üöÄ H·ªá th·ªëng S·∫¥N S√ÄNG.");
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') alert("ID ƒëang ch·∫°y ·ªü tab kh√°c!");
                else logSystem("L·ªói m·∫°ng: " + err.type);
            });

            // KHI C√ì CU·ªòC G·ªåI ƒê·∫æN (CONNECTION)
            peer.on('connection', (conn) => {
                // N·∫øu ƒëang b·∫≠n -> T·ª´ ch·ªëi ngay
                if (activeConn) {
                    setTimeout(() => { conn.send("BUSY_NOW"); conn.close(); }, 500);
                    return;
                }

                // N·∫øu ƒëang r·∫£nh -> Reng chu√¥ng
                pendingConn = conn;
                showIncomingCall();
            });
        }

        // --- X·ª¨ L√ù CU·ªòC G·ªåI ƒê·∫æN ---
        function showIncomingCall() {
            // 1. B·∫≠t nh·∫°c chu√¥ng
            try {
                ringtone.currentTime = 0;
                ringtone.play().catch(e => console.log("C·∫ßn t∆∞∆°ng t√°c ƒë·ªÉ ph√°t nh·∫°c"));
            } catch(e) {}

            // 2. Hi·ªán Modal
            incomingModal.style.display = 'flex';
        }

        // N√∫t NGHE M√ÅY
        document.getElementById('btnAnswer').addEventListener('click', () => {
            ringtone.pause();
            incomingModal.style.display = 'none';
            
            if (pendingConn) {
                acceptCall(pendingConn);
            }
        });

        // N√∫t T·ª™ CH·ªêI
        document.getElementById('btnReject').addEventListener('click', () => {
            ringtone.pause();
            incomingModal.style.display = 'none';
            
            if (pendingConn) {
                pendingConn.send("BUSY_NOW"); // Ho·∫∑c g·ª≠i tin nh·∫Øn t·ª´ ch·ªëi
                setTimeout(() => pendingConn.close(), 500);
                pendingConn = null;
            }
        });

        // H√ÄM CH·∫§P NH·∫¨N K·∫æT N·ªêI
        function acceptCall(conn) {
            activeConn = conn;
            pendingConn = null;
            
            setStatus('busy');
            document.getElementById('endCallBtn').style.display = 'flex';
            logSystem("üìû ƒê√É K·∫æT N·ªêI V·ªöI KH√ÅCH H√ÄNG!");

            // G·ªçi video l·∫°i cho kh√°ch
            const call = peer.call(conn.peer, localStream);
            activeCall = call;

            conn.on('data', (data) => {
                if(data === 'USER_DISCONNECT') endSession();
                else addMessage(data, 'client');
            });

            conn.on('close', endSession);
        }

        // --- C√ÅC N√öT ƒêI·ªÄU KHI·ªÇN KH√ÅC ---
        document.getElementById('btnToggleMic').addEventListener('click', function() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                this.classList.toggle('on'); this.classList.toggle('off');
                this.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            }
        });

        document.getElementById('btnToggleCam').addEventListener('click', function() {
            if (!localStream || !isVideoAvailable) return; 
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                this.classList.toggle('on'); this.classList.toggle('off');
                this.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
                document.getElementById('videoPlaceholder').style.display = videoTrack.enabled ? 'none' : 'block';
            }
        });

        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        
        function sendMessage() {
            const text = msgInput.value.trim();
            if (text && activeConn) {
                activeConn.send(text);
                addMessage(text, 'me');
                msgInput.value = '';
            }
        }
        sendBtn.addEventListener('click', sendMessage);
        msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage() });

        document.getElementById('endCallBtn').addEventListener('click', () => {
            if(activeConn) activeConn.send("STAFF_END");
            endSession();
        });

        function endSession() {
            if (activeConn) { activeConn.close(); activeConn = null; }
            if (activeCall) { activeCall.close(); activeCall = null; }
            setStatus('online');
            document.getElementById('endCallBtn').style.display = 'none';
            logSystem("‚èπÔ∏è ƒê√É K·∫æT TH√öC CU·ªòC G·ªåI.");
        }

        function setStatus(state) {
            const el = document.getElementById('connectionStatus');
            if (state === 'online') el.innerHTML = '<span class="status-badge st-online">S·∫µn s√†ng</span>';
            if (state === 'busy') el.innerHTML = '<span class="status-badge st-busy">ƒêang b·∫≠n</span>';
        }

        function logSystem(text) {
            const div = document.createElement('div');
            div.className = 'msg system';
            div.innerText = text;
            document.getElementById('msgList').appendChild(div);
        }

        function addMessage(msg, type) {
            const div = document.createElement('div');
            div.className = 'msg ' + type;
            if(msg.includes('http')) div.innerHTML = msg.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:yellow;">$1</a>');
            else div.innerText = msg;
            const list = document.getElementById('msgList');
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        initStaff();
    </script>
</body>
</html>